<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엑셀 연동 어휘 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F5F5DC; /* Calm Beige */
        }
        .quiz-card {
            background-color: #FFFFFF;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .btn-primary {
            background-color: #6B8E23; /* Sage Green */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #556B2F; /* Darker Sage */
        }
        .btn-primary:disabled {
            background-color: #909d7a;
            cursor: not-allowed;
        }
        .btn-option {
            background-color: #F0EAD6; /* Light Beige */
            border: 2px solid #D2B48C; /* Tan */
            color: #333;
            transition: all 0.2s ease-in-out;
        }
        .btn-option:hover {
            background-color: #D2B48C;
            color: white;
        }
        .btn-option.correct {
            background-color: #22C55E; /* Green 500 */
            border-color: #16A34A; /* Green 600 */
            color: white;
        }
        .btn-option.incorrect {
            background-color: #EF4444; /* Red 500 */
            border-color: #DC2626; /* Red 600 */
            color: white;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto">

        <div id="start-screen" class="text-center p-8 quiz-card">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">어휘력 퀴즈 챌린지</h1>
            <p class="text-lg text-gray-600 mb-8">엑셀 파일의 단어들을 퀴즈로 확인해 보세요. 준비가 되면 시작 버튼을 눌러주세요!</p>
            <button id="start-btn" class="w-full md:w-1/2 py-4 px-6 text-xl font-bold rounded-lg btn-primary">
                퀴즈 시작하기
            </button>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="p-6 sm:p-8 quiz-card">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-sm font-semibold text-gray-500">진행도</p>
                    <p id="progress-text" class="text-sm font-bold text-gray-700">1 / 10</p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="bg-[#6B8E23] h-2.5 rounded-full progress-bar-inner" style="width: 10%"></div>
                </div>

                <div class="text-center mb-8">
                    <p class="text-lg text-gray-600 mb-2">다음 설명에 해당하는 영어 단어는 무엇일까요?</p>
                    <h2 id="question" class="text-2xl sm:text-3xl font-bold text-gray-800 h-24 flex items-center justify-center">Question text goes here</h2>
                </div>

                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
        </div>

        <div id="results-screen" class="hidden text-center p-8 quiz-card">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">퀴즈 결과</h1>
            <p class="text-2xl text-gray-600 mb-6">총 <span id="score" class="font-bold text-[#6B8E23]">0</span>점을 획득했습니다!</p>
            
            <div id="incorrect-answers-container" class="text-left mb-8">
                <h3 class="text-xl font-semibold text-gray-700 border-b-2 pb-2 mb-4">다시 학습해 보세요!</h3>
                <ul id="incorrect-list" class="space-y-3">
                    </ul>
            </div>

            <button id="restart-btn" class="w-full md:w-1/2 py-4 px-6 text-xl font-bold rounded-lg btn-primary">
                다시 풀어보기
            </button>
        </div>
    </div>

    <script>
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');

        const questionEl = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const scoreEl = document.getElementById('score');
        const incorrectList = document.getElementById('incorrect-list');

        let allWords = []; // 엑셀에서 불러온 모든 단어를 저장할 배열
        let shuffledWords, currentWordIndex, score, incorrectAnswers;
        const QUIZ_LENGTH = 10;

        // 2. 엑셀 파일을 로드하고 파싱하는 함수
        async function loadQuizData() {
            try {
                // './quiz.xlsx'는 이 HTML 파일과 동일한 위치에 파일이 있다는 의미입니다.
                // 만약 /data/quiz.xlsx 처럼 다른 폴더에 있다면 경로를 수정해주세요.
                const response = await fetch('./quiz.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                // 컬럼 이름이 유동적일 수 있으므로, 첫 번째 데이터의 키(key)들을 기반으로 매핑합니다.
                if (jsonData.length === 0) {
                    throw new Error('엑셀 파일에 데이터가 없습니다.');
                }
                const headers = Object.keys(jsonData[0]); // ["단어 (Word)", "영영풀이...", "뜻..."]
                
                // 데이터 형식을 { word, definition, meaning } 으로 통일합니다.
                allWords = jsonData.map(row => ({
                    word: row[headers[0]],       // 첫 번째 열을 단어로 가정
                    definition: row[headers[2]], // 세 번째 열을 영영풀이로 가정
                    meaning: row[headers[3]]     // 네 번째 열을 한글 뜻으로 가정
                }));

                return true; // 성공적으로 로드됨
            } catch (error) {
                console.error('퀴즈 데이터를 불러오는 데 실패했습니다:', error);
                alert('quiz.xlsx 파일을 불러올 수 없습니다. 파일이 올바른 위치에 있는지 확인해주세요.');
                return false; // 로드 실패
            }
        }

        function shuffleArray(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        async function startGame() {
            startBtn.disabled = true;
            startBtn.textContent = '데이터 로딩 중...';
            
            const isDataLoaded = await loadQuizData();
            if (!isDataLoaded) {
                startBtn.disabled = false;
                startBtn.textContent = '퀴즈 시작하기';
                return; // 데이터 로드 실패 시 게임 시작 안함
            }

            startScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');

            // 퀴즈 단어 수가 10개 미만일 경우를 대비
            const quizSetLength = Math.min(QUIZ_LENGTH, allWords.length);
            shuffledWords = shuffleArray([...allWords]).slice(0, quizSetLength);
            currentWordIndex = 0;
            score = 0;
            incorrectAnswers = [];
            
            displayNextQuestion();
        }

        function displayNextQuestion() {
            const quizSetLength = shuffledWords.length;
            if (currentWordIndex < quizSetLength) {
                updateProgress();
                const currentWord = shuffledWords[currentWordIndex];
                
                // 질문이 될 내용(영영풀이, 한글뜻)이 비어있지 않은지 확인
                const questionText = currentWord.definition || currentWord.meaning;
                questionEl.textContent = questionText || "정의 없음"; // 둘 다 비어있을 경우 대비

                const options = getOptions(currentWord);
                optionsContainer.innerHTML = '';

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.word;
                    button.classList.add('w-full', 'p-4', 'text-lg', 'font-semibold', 'rounded-lg', 'btn-option');
                    button.onclick = () => selectAnswer(button, option.correct);
                    optionsContainer.appendChild(button);
                });
            } else {
                showResults();
            }
        }
        
        function getOptions(correctWord) {
            const options = [{ word: correctWord.word, correct: true }];
            const distractors = allWords.filter(w => w.word !== correctWord.word);
            const shuffledDistractors = shuffleArray(distractors);

            // 보기 3개를 추가. 전체 단어 수가 4개 미만일 경우를 대비
            const count = Math.min(3, shuffledDistractors.length);
            for (let i = 0; i < count; i++) {
                options.push({ word: shuffledDistractors[i].word, correct: false });
            }
            
            return shuffleArray(options);
        }

        function selectAnswer(button, isCorrect) {
            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
            });

            if (isCorrect) {
                score++;
                button.classList.add('correct');
            } else {
                button.classList.add('incorrect');
                incorrectAnswers.push(shuffledWords[currentWordIndex]);
                const correctButton = Array.from(optionsContainer.children).find(btn => {
                    const correctWord = shuffledWords[currentWordIndex].word;
                    return btn.textContent === correctWord;
                });
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
            }

            setTimeout(() => {
                currentWordIndex++;
                displayNextQuestion();
            }, 1500);
        }
        
        function updateProgress() {
            const quizSetLength = shuffledWords.length;
            const progress = ((currentWordIndex + 1) / quizSetLength) * 100;
            progressText.textContent = `${currentWordIndex + 1} / ${quizSetLength}`;
            progressBar.style.width = `${progress}%`;
        }

        function showResults() {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            const quizSetLength = shuffledWords.length;
            scoreEl.textContent = `${score} / ${quizSetLength}`;
            incorrectList.innerHTML = '';

            if (incorrectAnswers.length === 0) {
                const li = document.createElement('li');
                li.textContent = '🎉 완벽해요! 틀린 문제가 없습니다.';
                li.classList.add('text-green-600', 'font-semibold');
                incorrectList.appendChild(li);
            } else {
                incorrectAnswers.forEach(word => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="font-bold text-gray-800">${word.word}</span>: ${word.meaning || word.definition}`;
                    li.classList.add('text-gray-600');
                    incorrectList.appendChild(li);
                });
            }
        }

        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', () => {
             // Reset start button state for next game
            startBtn.disabled = false;
            startBtn.textContent = '퀴즈 시작하기';
            resultsScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });

    </script>
</body>
</html>
